<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hermann Park Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        
        .prompt-text {
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center overflow-x-hidden">

    <!-- Compact Mobile Header -->
    <header class="w-full text-center py-3 bg-slate-800 shadow-md z-10 sticky top-0">
        <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 inline-block">
            Hermann Park Bingo
        </h1>
        <div id="status-indicator" class="text-[10px] text-gray-400 mt-1 h-4">Loading saved game...</div>
    </header>

    <!-- Main Content -->
    <div class="w-full max-w-md flex-grow flex flex-col p-2 gap-3 justify-center">
        
        <!-- The Board -->
        <div id="game-board" class="grid grid-cols-5 gap-1 w-full aspect-square bg-slate-800 p-1 rounded-xl shadow-2xl border border-slate-700">
            <!-- Squares generated by JS -->
        </div>

        <!-- Action Bar -->
        <div class="grid grid-cols-2 gap-3 mt-2">
            <button onclick="resetBoard()" class="bg-red-500/10 border border-red-500/50 text-red-400 active:bg-red-600 active:text-white py-3 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>Reset</span>
            </button>
            <button onclick="exportGrid()" id="export-btn" class="bg-blue-600 text-white active:bg-blue-700 py-3 rounded-xl font-bold text-sm shadow-lg transition-colors flex items-center justify-center gap-2">
                <span>Save Image</span>
            </button>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="global-file-input" accept="image/*" capture="environment" class="hidden">

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xs border border-slate-700 shadow-2xl flex flex-col gap-3">
            <h3 class="text-lg font-bold text-center mb-2 text-white">Edit Square</h3>
            <button id="btn-change" class="bg-blue-600 text-white py-3 rounded-xl font-semibold active:bg-blue-500">
                Retake / Upload
            </button>
            <button id="btn-delete" class="bg-red-600 text-white py-3 rounded-xl font-semibold active:bg-red-500">
                Clear Photo
            </button>
            <button onclick="closeModal()" class="bg-slate-700 text-slate-300 py-3 rounded-xl font-semibold active:bg-slate-600 mt-2">
                Cancel
            </button>
        </div>
    </div>

    <!-- Hidden Export Container -->
    <div style="position: absolute; left: -9999px; top: 0;">
        <div id="export-container" class="bg-white p-6 w-[1200px]">
            <div class="mb-4 text-center border-b-4 border-green-500 pb-4">
                <h1 class="text-5xl font-black text-slate-800 tracking-tighter uppercase">Hermann Park</h1>
                <p class="text-slate-500 text-xl font-bold mt-2 tracking-widest uppercase">Scavenger Hunt â€¢ <span id="export-date"></span></p>
            </div>
            <div id="export-grid" class="grid grid-cols-5 gap-2 bg-slate-100 p-2 border-4 border-slate-800">
                <!-- Export content -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_NAME = 'HermannBingoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'photos';
        const PROMPT_STORAGE_KEY = 'hermann-bingo-prompts-v2';
        const CENTER_INDEX = 12;
        const CENTER_PROMPT = 'Rice Student';

        // Larger prompt pool (excluding fixed center tile when drawing)
        const PROMPT_POOL = [
            "Turtle",
            "Bird",
            "Squirrel",
            "Handstand",
            "Someone with Hat",
            "Fountain",
            "Miller Theatre",
            "Reflecting Pool",
            "Japanese Garden",
            "Koi Fish",
            "Sam Houston Statue",
            "Pedal Boat",
            "Picnic Blanket",
            "Family with Stroller",
            "Couple on a Bench",
            "Dog on a Leash",
            "High Five with a Stranger",
            "Group Jumping Photo",
            "Shadow Selfie",
            "Sign: 'Hermann'",
            "Flower Close-up",
            "Statue Close-up",
            "In a Tunnel",
            "Twisty Tree",
            "Science Museum",
            "Pinecone or Leaf",
            "Bike or Scooter",
            "Train Passing By",
            "Selfie with a Friend",
            "Kids Playing",
            "Jogger or Runner",
            "Person Reading",
            "Person on a Bench with Headphones",
            "Person Walking a Pet",
            "People Playing a Game",
            "Person Wearing Green",
            "Person Taking a Photo"
        ];

        // --- STATE ---
        let db = null;
        let photoState = new Array(25).fill(null);
        let activeIndex = null;
        let boardPrompts = new Array(25).fill("");

        // --- DOM ELEMENTS (initialized on DOMContentLoaded) ---
        let boardEl, fileInput, modal, statusEl;

        // --- UTILITIES ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function buildNewBoardPrompts() {
            const pool = PROMPT_POOL.slice();
            const filteredPool = pool.filter(p => p !== CENTER_PROMPT);
            shuffleArray(filteredPool);

            const selected = filteredPool.slice(0, 24);
            const result = [];
            let selIndex = 0;
            for (let i = 0; i < 25; i++) {
                if (i === CENTER_INDEX) {
                    result.push(CENTER_PROMPT);
                } else {
                    result.push(selected[selIndex++]);
                }
            }
            return result;
        }

        function loadOrCreateBoardPrompts() {
            try {
                const saved = localStorage.getItem(PROMPT_STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length === 25) {
                        boardPrompts = parsed;
                        return;
                    }
                }
            } catch (e) {
                console.error("Error loading prompts from storage", e);
            }
            boardPrompts = buildNewBoardPrompts();
            try {
                localStorage.setItem(PROMPT_STORAGE_KEY, JSON.stringify(boardPrompts));
            } catch (e) {
                console.error("Error saving prompts to storage", e);
            }
        }

        function regenerateBoardPrompts() {
            try {
                localStorage.removeItem(PROMPT_STORAGE_KEY);
            } catch (e) {
                console.error("Error clearing prompts from storage", e);
            }
            boardPrompts = buildNewBoardPrompts();
            try {
                localStorage.setItem(PROMPT_STORAGE_KEY, JSON.stringify(boardPrompts));
            } catch (e) {
                console.error("Error saving prompts to storage", e);
            }
        }

        // --- INDEXED DB SETUP (PERSISTENCE) ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };

            request.onsuccess = (e) => {
                db = e.target.result;
                loadGame();
            };

            request.onerror = (e) => {
                console.error("DB Error", e);
                if (statusEl) statusEl.innerText = "Error loading save data.";
            };
        }

        function savePhotoToDB(index, base64Data) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put(base64Data, index);
            if (statusEl) statusEl.innerText = "Game saved automatically.";
        }

        function deletePhotoFromDB(index) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.delete(index);
            if (statusEl) statusEl.innerText = "Photo removed.";
        }

        function loadGame() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            
            const request = store.openCursor();
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const index = cursor.key;
                    const data = cursor.value;
                    photoState[index] = data;
                    updateSquareVisuals(index, data);
                    cursor.continue();
                } else {
                    if (statusEl) statusEl.innerText = "Ready to play!";
                }
            };
        }

        function clearDB() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.clear();
            if (statusEl) statusEl.innerText = "Board reset.";
        }

        // --- BOARD LOGIC ---
        function initBoard() {
            boardEl.innerHTML = '';
            boardPrompts.forEach((prompt, index) => {
                const square = document.createElement('div');
                square.id = `square-${index}`;
                
                let baseClasses = "relative w-full pt-[100%] rounded-md overflow-hidden cursor-pointer shadow-sm transition-transform active:scale-95 ";
                baseClasses += index === CENTER_INDEX ? "bg-emerald-700" : "bg-slate-700";
                
                square.className = baseClasses;
                square.onclick = () => handleSquareClick(index);

                square.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center p-1 z-10 pointer-events-none">
                        <span class="prompt-text text-[9px] sm:text-xs font-bold text-center leading-tight break-words text-white">${prompt}</span>
                    </div>
                    <div class="absolute inset-0 bg-cover bg-center z-0 hidden" id="img-${index}"></div>
                    <div class="absolute inset-0 bg-black/40 z-0 hidden" id="overlay-${index}"></div>
                    <div id="loading-${index}" class="hidden absolute inset-0 flex items-center justify-center bg-slate-800/80 z-20"><div class="loader"></div></div>
                    <div id="check-${index}" class="hidden absolute top-1 right-1 z-20 bg-green-500 rounded-full p-0.5 shadow-sm">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                `;
                boardEl.appendChild(square);

                // If there is already a saved photo for this index, reapply visuals
                if (photoState[index]) {
                    updateSquareVisuals(index, photoState[index]);
                }
            });
        }

        function handleSquareClick(index) {
            activeIndex = index;
            fileInput.setAttribute('data-index', index.toString());
            if (photoState[index]) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                triggerFileUpload();
            }
        }

        function triggerFileUpload() {
            fileInput.value = '';
            fileInput.click();
        }

        // --- IMAGE PROCESSING ---
        function setupFileInputListener() {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                const idxAttr = fileInput.getAttribute('data-index');
                const indexFromAttr = idxAttr !== null ? parseInt(idxAttr, 10) : null;
                const indexToUse = (activeIndex !== null) ? activeIndex : indexFromAttr;

                if (!file || indexToUse === null || isNaN(indexToUse)) return;

                const loadingEl = document.getElementById(`loading-${indexToUse}`);
                if (loadingEl) loadingEl.classList.remove('hidden');
                if (statusEl) statusEl.innerText = "Compressing photo...";

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Higher resolution while still compressing
                        const MAX_SIZE = 1200;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                        
                        photoState[indexToUse] = dataUrl;
                        savePhotoToDB(indexToUse, dataUrl);
                        updateSquareVisuals(indexToUse, dataUrl);
                        
                        if (loadingEl) loadingEl.classList.add('hidden');
                    };
                    img.onerror = () => {
                        alert("Could not load image.");
                        if (loadingEl) loadingEl.classList.add('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateSquareVisuals(index, dataUrl) {
            const square = document.getElementById(`square-${index}`);
            if (!square) return;

            const imgDiv = document.getElementById(`img-${index}`);
            const overlay = document.getElementById(`overlay-${index}`);
            const check = document.getElementById(`check-${index}`);
            const text = square.querySelector('.prompt-text');

            if (imgDiv) {
                imgDiv.style.backgroundImage = `url(${dataUrl})`;
                imgDiv.classList.remove('hidden');
            }
            if (overlay) overlay.classList.remove('hidden');
            if (check) check.classList.remove('hidden');
            if (text) text.classList.add('opacity-0');
            
            square.classList.remove('bg-slate-700', 'bg-emerald-700');
            square.classList.add('border-2', 'border-green-500');
        }

        // --- MODAL & RESET ---
        function setupModalButtons() {
            const btnChange = document.getElementById('btn-change');
            const btnDelete = document.getElementById('btn-delete');

            btnChange.onclick = () => {
                closeModal();
                setTimeout(triggerFileUpload, 50);
            };

            btnDelete.onclick = () => {
                const index = activeIndex;
                if (index === null) {
                    closeModal();
                    return;
                }
                photoState[index] = null;
                deletePhotoFromDB(index);
                
                const square = document.getElementById(`square-${index}`);
                const imgDiv = document.getElementById(`img-${index}`);
                const overlay = document.getElementById(`overlay-${index}`);
                const check = document.getElementById(`check-${index}`);

                if (imgDiv) imgDiv.classList.add('hidden');
                if (overlay) overlay.classList.add('hidden');
                if (check) check.classList.add('hidden');
                if (square) {
                    const text = square.querySelector('.prompt-text');
                    if (text) text.classList.remove('opacity-0');
                    square.classList.remove('border-2', 'border-green-500');
                    square.classList.add(index === CENTER_INDEX ? 'bg-emerald-700' : 'bg-slate-700');
                }
                
                closeModal();
            };

            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function resetBoard() {
            if (confirm("Clear entire board and prompts? All photos will be lost.")) {
                photoState = new Array(25).fill(null);
                clearDB();
                regenerateBoardPrompts();
                initBoard();
            }
        }

        // --- EXPORT ---
        async function exportGrid() {
            const btn = document.getElementById('export-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/50 border-t-white"></div> Saving...`;
            btn.disabled = true;

            try {
                const exportContainer = document.getElementById('export-grid');
                exportContainer.innerHTML = '';
                document.getElementById('export-date').innerText = new Date().toLocaleDateString();

                boardPrompts.forEach((prompt, index) => {
                    const div = document.createElement('div');
                    div.className = "aspect-square bg-slate-200 flex items-center justify-center relative border border-slate-300 overflow-hidden";
                    
                    if (photoState[index]) {
                        div.innerHTML = `
                            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url(${photoState[index]})"></div>
                            <div class="absolute bottom-0 left-0 right-0 bg-black/70 p-1">
                                <p class="text-white text-[10px] font-bold text-center leading-none truncate font-sans">${prompt}</p>
                            </div>
                        `;
                    } else {
                         div.innerHTML = `<p class="text-slate-400 text-[10px] text-center font-bold p-1 leading-tight font-sans uppercase tracking-wide">${prompt}</p>`;
                    }
                    exportContainer.appendChild(div);
                });

                await new Promise(r => setTimeout(r, 100));
                const canvas = await html2canvas(document.getElementById('export-container'), {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });

                const link = document.createElement('a');
                link.download = `Hermann-Hunt-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

            } catch (e) {
                console.error(e);
                alert("Export failed. Try reloading.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- STARTUP ---
        window.addEventListener('DOMContentLoaded', () => {
            boardEl = document.getElementById('game-board');
            fileInput = document.getElementById('global-file-input');
            modal = document.getElementById('edit-modal');
            statusEl = document.getElementById('status-indicator');

            loadOrCreateBoardPrompts();
            setupFileInputListener();
            setupModalButtons();
            initBoard();
            initDB();
        });
    </script>
</body>
</html>
