<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Photo Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        .prompt-text {
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Smooth fade for modal */
        .fade-enter { opacity: 0; transform: scale(0.95); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col items-center overflow-x-hidden selection:bg-green-500 selection:text-white">

    <!-- Header with location selector -->
    <header class="w-full text-center py-4 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-30">
        <h1 class="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500 inline-block">
            Photo Bingo
        </h1>
        
        <div class="mt-2 flex items-center justify-center gap-2">
            <div class="relative group">
                <select id="location-select" class="appearance-none bg-slate-800 text-sm text-slate-200 font-medium rounded-full pl-4 pr-8 py-1.5 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 transition-all cursor-pointer hover:bg-slate-750">
                    <option value="hermann">Hermann Park (Houston)</option>
                    <option value="venice">Venice Beach (LA)</option>
                    <option value="panpacific">Pan-Pacific Park (LA)</option>
                </select>
                <!-- Custom Chevron -->
                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </div>
            </div>
        </div>
        <div id="status-indicator" class="text-[10px] font-medium text-slate-500 mt-1.5 h-3 uppercase tracking-wider opacity-0 transition-opacity duration-300">Ready</div>
    </header>

    <!-- Main Content -->
    <div class="w-full max-w-md flex-grow flex flex-col p-4 gap-4 justify-start items-center">
        
        <!-- The Board -->
        <div id="game-board" class="grid grid-cols-5 gap-1.5 w-full aspect-square bg-slate-900 p-2 rounded-2xl shadow-2xl shadow-black/50 border border-slate-800">
            <!-- Squares generated by JS -->
        </div>

        <!-- Modern Action Bar -->
        <div class="w-full grid grid-cols-2 gap-4 mt-2">
            <!-- Reset Button -->
            <button onclick="resetBoard()" class="group relative overflow-hidden rounded-full bg-slate-800 border border-slate-700 text-slate-300 py-3.5 font-semibold text-sm transition-all active:scale-95 hover:bg-slate-750 hover:text-white hover:border-slate-600 shadow-lg">
                <div class="flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    <span>Reset Board</span>
                </div>
            </button>

            <!-- Save Button -->
            <button onclick="exportGrid()" id="export-btn" class="group relative overflow-hidden rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 text-white py-3.5 font-bold text-sm shadow-lg shadow-emerald-900/20 transition-all active:scale-95 hover:shadow-emerald-500/25 hover:brightness-110">
                <div class="flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    <span>Save Image</span>
                </div>
            </button>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="global-file-input" accept="image/*" capture="environment" class="hidden">

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-950/80 hidden items-center justify-center z-50 p-6 backdrop-blur-sm transition-all duration-200 opacity-0 scale-95">
        <div class="bg-slate-900 rounded-3xl p-6 w-full max-w-xs border border-slate-800 shadow-2xl flex flex-col gap-3 relative overflow-hidden">
            <!-- Decorative gloss -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-500 via-cyan-500 to-blue-500"></div>
            
            <h3 class="text-xl font-bold text-center mb-2 text-white">Edit Square</h3>
            
            <button id="btn-change" class="bg-slate-800 text-emerald-400 border border-slate-700 hover:bg-slate-750 hover:border-emerald-500/50 py-3.5 rounded-xl font-semibold active:scale-98 transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                Retake Photo
            </button>
            
            <button id="btn-delete" class="bg-slate-800 text-red-400 border border-slate-700 hover:bg-red-900/20 hover:border-red-500/30 py-3.5 rounded-xl font-semibold active:scale-98 transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                Clear Square
            </button>
            
            <button onclick="closeModal()" class="mt-2 text-slate-500 font-medium text-sm hover:text-slate-300 py-2 transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <!-- Hidden Export Template (High Resolution) -->
    <div style="position: absolute; left: -9999px; top: 0;">
        <div id="export-container" class="bg-white p-12 w-[1200px] font-sans">
            <div class="mb-8 text-center border-b-8 border-slate-900 pb-8">
                <h1 id="export-location-name" class="text-6xl font-black text-slate-900 tracking-tighter uppercase mb-2">Hermann Park</h1>
                <div class="flex items-center justify-center gap-4 text-slate-500 text-2xl font-bold tracking-widest uppercase">
                    <span class="bg-slate-900 text-white px-3 py-1 rounded-md">BINGO</span>
                    <span>â€¢</span>
                    <span id="export-date"></span>
                </div>
            </div>
            <div id="export-grid" class="grid grid-cols-5 gap-4 bg-slate-100 p-4 border-8 border-slate-900 rounded-xl">
                <!-- Export content populates here -->
            </div>
            <div class="mt-6 text-center">
                 <p class="text-slate-400 font-semibold text-lg">Created with Photo Bingo</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_NAME = 'HermannBingoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'photos';
        const CENTER_INDEX = 12;
        const PROMPT_STORAGE_BASE_KEY = 'hermann-bingo-prompts-v2';

        // Location Configuration
        const LOCATIONS = {
            hermann: {
                name: "Hermann Park",
                displayName: "Hermann Park",
                centerPrompt: "Rice Student",
                pool: [
                    "Turtle", "Bird", "Squirrel", "Handstand", "Someone with Hat", 
                    "Fountain", "Miller Theatre", "Reflecting Pool", "Japanese Garden", "Koi Fish",
                    "Sam Houston Statue", "Pedal Boat", "Picnic Blanket", "Family with Stroller",
                    "Couple on a Bench", "Dog on a Leash", "High Five w/ Stranger", "Group Jump Photo",
                    "Shadow Selfie", "Sign: 'Hermann'", "Flower Close-up", "Statue Close-up",
                    "In a Tunnel", "Twisty Tree", "Science Museum", "Pinecone or Leaf",
                    "Bike or Scooter", "Train Passing By", "Selfie with Friend", "Kids Playing",
                    "Jogger/Runner", "Person Reading", "Person w/ Headphones", "Person Walking Pet",
                    "People Playing Game", "Person Wearing Green", "Person Taking Photo"
                ]
            },
            venice: {
                name: "Venice Beach",
                displayName: "Venice Beach",
                centerPrompt: "Venice Sign",
                pool: [
                    "Lifeguard Selfie", "Surfer", "Skate Park Trick", "Beach Volleyball",
                    "Palm Trees", "Bikes", "Beach Workout", "Street Performer",
                    "Graffiti Wall", "Dog", "Sunset", "Sandcastle",
                    "Couple Selfie", "Roller Skater", "Surfboard", "Food Truck",
                    "Street Vendor", "Artist Painting", "Skateboarder", "Sunglasses",
                    "Group Jump Photo", "High Five a Stranger", "Shadow Selfie", "Beach Umbrella",
                    "Kite in Sky", "Birds Over Water", "Lifeguard Truck", "Playing Frisbee",
                    "Jogger", "Friend Circle", "Haduken",
                    "Colorful Storefront", "Mural Close-up", "Feet in Sand", "Waves", "Person in Hat"
                ]
            },
            panpacific: {
                name: "Pan-Pacific Park",
                displayName: "Pan-Pacific Park",
                centerPrompt: "Park Fountain",
                pool: [
                    "Playground", "Basketball Court", "Soccer Game", "Dogs Playing", "Picnic Table",
                    "View of The Grove", "Jogger on Path", "Palm Tree Row", "Park Fountain", "Children Playing",
                    "Skateboarder", "Person Walking Dog", "Family Picnic", "Reading on Bench", "Bike or Scooter",
                    "Stretching", "Outdoor Workout", "High Five w/ Stranger", "Group Jump", "Shadow Selfie",
                    "Park Sign/Map", "Flower Bed", "Bird or Squirrel", "Sports Jersey", "Playing Catch",
                    "Stroller", "Water Bottle", "Bench Line-up", "Golden Hour Light", "Friends Walking",
                    "Person on Phone", "Pathway Curve", "Trees Against Sky", "Fist Bump Stranger",
                    "Person in Hat", "Trash/Recycle Can", "View Toward City"
                ]
            }
        };

        // --- STATE ---
        let currentLocationKey = 'hermann';
        let db = null;
        let photoState = new Array(25).fill(null);
        let activeIndex = null;
        let boardPrompts = new Array(25).fill("");

        // --- DOM ELEMENTS ---
        let boardEl, fileInput, modal, statusEl, locationSelect;

        // --- UTILITIES ---
        function getCurrentLocationConfig() {
            return LOCATIONS[currentLocationKey];
        }

        function getPromptStorageKey() {
            return `${PROMPT_STORAGE_BASE_KEY}-${currentLocationKey}`;
        }

        function showStatus(msg) {
            if(!statusEl) return;
            statusEl.innerText = msg;
            statusEl.style.opacity = '1';
            setTimeout(() => { statusEl.style.opacity = '0'; }, 3000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function buildNewBoardPrompts() {
            const { centerPrompt, pool } = getCurrentLocationConfig();
            const filteredPool = pool.filter(p => p !== centerPrompt);
            shuffleArray(filteredPool);

            const selected = filteredPool.slice(0, 24);
            const result = [];
            let selIndex = 0;
            for (let i = 0; i < 25; i++) {
                if (i === CENTER_INDEX) {
                    result.push(centerPrompt);
                } else {
                    result.push(selected[selIndex++]);
                }
            }
            return result;
        }

        function loadOrCreateBoardPrompts() {
            const storageKey = getPromptStorageKey();
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length === 25) {
                        boardPrompts = parsed;
                        return;
                    }
                }
            } catch (e) { console.error(e); }
            boardPrompts = buildNewBoardPrompts();
            localStorage.setItem(storageKey, JSON.stringify(boardPrompts));
        }

        function regenerateBoardPrompts() {
            const storageKey = getPromptStorageKey();
            localStorage.removeItem(storageKey);
            boardPrompts = buildNewBoardPrompts();
            localStorage.setItem(storageKey, JSON.stringify(boardPrompts));
        }

        function updateLocationUI() {
            const config = getCurrentLocationConfig();
            document.title = `${config.name} Bingo`;
        }

        // --- INDEXED DB (IMAGES) ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                loadGame();
            };
            request.onerror = (e) => showStatus("Error loading database.");
        }

        function savePhotoToDB(index, base64Data) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(base64Data, index);
            showStatus("Photo saved.");
        }

        function deletePhotoFromDB(index) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete(index);
            showStatus("Photo cleared.");
        }

        function loadGame() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readonly');
            const request = tx.objectStore(STORE_NAME).openCursor();
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const index = cursor.key;
                    const data = cursor.value;
                    photoState[index] = data;
                    updateSquareVisuals(index, data);
                    cursor.continue();
                }
            };
        }

        function clearDB() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).clear();
        }

        // --- BOARD RENDERING ---
        function initBoard() {
            boardEl.innerHTML = '';
            boardPrompts.forEach((prompt, index) => {
                const square = document.createElement('div');
                square.id = `square-${index}`;
                
                let baseClasses = "relative w-full pt-[100%] rounded-xl overflow-hidden cursor-pointer transition-all duration-200 active:scale-95 hover:brightness-110 ";
                // Center square distinct style
                baseClasses += index === CENTER_INDEX ? "bg-gradient-to-br from-emerald-700 to-emerald-900 shadow-inner" : "bg-slate-800 shadow-sm";
                
                square.className = baseClasses;
                square.onclick = () => handleSquareClick(index);

                square.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center p-1.5 z-10 pointer-events-none">
                        <span class="prompt-text text-[10px] sm:text-xs font-semibold text-center leading-tight break-words text-slate-200/90">${prompt}</span>
                    </div>
                    <div class="absolute inset-0 bg-cover bg-center z-0 hidden transition-opacity duration-500" id="img-${index}"></div>
                    <div class="absolute inset-0 bg-black/20 z-0 hidden" id="overlay-${index}"></div>
                    <div id="loading-${index}" class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/80 z-20 backdrop-blur-sm"><div class="loader"></div></div>
                    <div id="check-${index}" class="hidden absolute top-1.5 right-1.5 z-20 bg-emerald-500 text-white rounded-full p-0.5 shadow-md transform scale-0 transition-transform duration-300">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                `;
                boardEl.appendChild(square);

                if (photoState[index]) {
                    updateSquareVisuals(index, photoState[index]);
                }
            });
        }

        function handleSquareClick(index) {
            activeIndex = index;
            fileInput.setAttribute('data-index', index.toString());
            if (photoState[index]) {
                openModal();
            } else {
                triggerFileUpload();
            }
        }

        function triggerFileUpload() {
            fileInput.value = '';
            fileInput.click();
        }

        // --- IMAGE HANDLING ---
        function setupFileInputListener() {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                const indexToUse = (activeIndex !== null) ? activeIndex : parseInt(fileInput.getAttribute('data-index'), 10);

                if (!file || isNaN(indexToUse)) return;

                const loadingEl = document.getElementById(`loading-${indexToUse}`);
                if (loadingEl) loadingEl.classList.remove('hidden');

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 1000; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // Compress
                        
                        photoState[indexToUse] = dataUrl;
                        savePhotoToDB(indexToUse, dataUrl);
                        updateSquareVisuals(indexToUse, dataUrl);
                        
                        if (loadingEl) loadingEl.classList.add('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateSquareVisuals(index, dataUrl) {
            const square = document.getElementById(`square-${index}`);
            if (!square) return;

            const imgDiv = document.getElementById(`img-${index}`);
            const overlay = document.getElementById(`overlay-${index}`);
            const check = document.getElementById(`check-${index}`);
            const text = square.querySelector('.prompt-text');

            if (imgDiv) {
                imgDiv.style.backgroundImage = `url(${dataUrl})`;
                imgDiv.classList.remove('hidden');
            }
            if (overlay) overlay.classList.remove('hidden');
            if (check) {
                check.classList.remove('hidden');
                // Tiny timeout to trigger CSS transition for pop effect
                setTimeout(() => check.classList.remove('scale-0'), 50);
            }
            if (text) text.classList.add('opacity-0');
            
            square.classList.remove('bg-slate-800', 'bg-emerald-700');
            square.classList.add('ring-2', 'ring-emerald-500', 'ring-offset-2', 'ring-offset-slate-900');
        }

        // --- MODAL LOGIC ---
        function openModal() {
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0', 'scale-95');
            modal.classList.add('flex', 'opacity-100', 'scale-100');
        }

        function closeModal() {
            modal.classList.remove('opacity-100', 'scale-100');
            modal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        function setupModalButtons() {
            document.getElementById('btn-change').onclick = () => {
                closeModal();
                setTimeout(triggerFileUpload, 250);
            };

            document.getElementById('btn-delete').onclick = () => {
                const index = activeIndex;
                if (index === null) return closeModal();
                
                photoState[index] = null;
                deletePhotoFromDB(index);
                
                // Reset Visuals
                const square = document.getElementById(`square-${index}`);
                const imgDiv = document.getElementById(`img-${index}`);
                const overlay = document.getElementById(`overlay-${index}`);
                const check = document.getElementById(`check-${index}`);
                const text = square.querySelector('.prompt-text');

                if (imgDiv) imgDiv.classList.add('hidden');
                if (overlay) overlay.classList.add('hidden');
                if (check) {
                    check.classList.add('scale-0');
                    setTimeout(() => check.classList.add('hidden'), 200);
                }
                if (text) text.classList.remove('opacity-0');
                if (square) {
                    square.classList.remove('ring-2', 'ring-emerald-500', 'ring-offset-2', 'ring-offset-slate-900');
                    square.classList.add(index === CENTER_INDEX ? 'bg-emerald-700' : 'bg-slate-800');
                }
                
                closeModal();
            };

            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function resetBoard() {
            if (confirm("Start a new game? This will clear all photos and shuffle prompts.")) {
                photoState = new Array(25).fill(null);
                clearDB();
                regenerateBoardPrompts();
                initBoard();
                showStatus("Board reset!");
            }
        }

        // --- EXPORT LOGIC ---
        async function exportGrid() {
            const btn = document.getElementById('export-btn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = `<div class="loader"></div>`;
            btn.disabled = true;

            try {
                const exportContainer = document.getElementById('export-grid');
                exportContainer.innerHTML = '';
                document.getElementById('export-date').innerText = new Date().toLocaleDateString();

                // DYNAMICALLY UPDATE EXPORT TEMPLATE TITLE
                const locConfig = getCurrentLocationConfig();
                const exportTitle = document.getElementById('export-location-name');
                exportTitle.textContent = locConfig.name;

                boardPrompts.forEach((prompt, index) => {
                    const div = document.createElement('div');
                    div.className = "aspect-square bg-slate-200 flex items-center justify-center relative border-2 border-slate-300 overflow-hidden rounded-lg";
                    
                    if (photoState[index]) {
                        div.innerHTML = `
                            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url(${photoState[index]})"></div>
                            <div class="absolute bottom-0 left-0 right-0 bg-slate-900/80 p-1.5">
                                <p class="text-white text-[12px] font-bold text-center leading-none truncate font-sans">${prompt}</p>
                            </div>
                        `;
                        div.style.borderColor = "#10b981"; // Green border for filled
                    } else {
                         div.innerHTML = `<div class="p-2"><p class="text-slate-400 text-[12px] text-center font-bold leading-tight uppercase tracking-wide">${prompt}</p></div>`;
                    }
                    exportContainer.appendChild(div);
                });

                await new Promise(r => setTimeout(r, 100)); // Wait for DOM
                
                const canvas = await html2canvas(document.getElementById('export-container'), {
                    scale: 2, // High quality
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });

                const safeName = locConfig.name.replace(/\s+/g, '-');
                const link = document.createElement('a');
                link.download = `${safeName}-Bingo-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.90);
                link.click();

            } catch (e) {
                console.error(e);
                alert("Could not save image. Try again.");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            boardEl = document.getElementById('game-board');
            fileInput = document.getElementById('global-file-input');
            modal = document.getElementById('edit-modal');
            statusEl = document.getElementById('status-indicator');
            locationSelect = document.getElementById('location-select');

            locationSelect.addEventListener('change', (e) => {
                currentLocationKey = e.target.value;
                updateLocationUI();
                photoState = new Array(25).fill(null);
                clearDB();
                loadOrCreateBoardPrompts();
                initBoard();
                showStatus("Location switched!");
            });

            locationSelect.value = currentLocationKey;
            updateLocationUI();
            loadOrCreateBoardPrompts();
            setupFileInputListener();
            setupModalButtons();
            initBoard();
            initDB();
        });
    </script>
</body>
</html>
