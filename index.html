<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hermann Park Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        
        .prompt-text {
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Hide scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center overflow-x-hidden">

    <!-- Compact Mobile Header -->
    <header class="w-full text-center py-3 bg-slate-800 shadow-md z-10 sticky top-0">
        <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 inline-block">
            Hermann Park Bingo
        </h1>
        <div id="status-indicator" class="text-[10px] text-gray-400 mt-1 h-4">Loading saved game...</div>
    </header>

    <!-- Main Content -->
    <div class="w-full max-w-md flex-grow flex flex-col p-2 gap-3 justify-center">
        
        <!-- The Board: Optimized for Mobile (gap-1) -->
        <div id="game-board" class="grid grid-cols-5 gap-1 w-full aspect-square bg-slate-800 p-1 rounded-xl shadow-2xl border border-slate-700">
            <!-- Squares generated by JS -->
        </div>

        <!-- Action Bar -->
        <div class="grid grid-cols-2 gap-3 mt-2">
            <button onclick="resetBoard()" class="bg-red-500/10 border border-red-500/50 text-red-400 active:bg-red-600 active:text-white py-3 rounded-xl font-bold text-sm transition-colors flex items-center justify-center gap-2">
                <span>Reset</span>
            </button>
            <button onclick="exportGrid()" id="export-btn" class="bg-blue-600 text-white active:bg-blue-700 py-3 rounded-xl font-bold text-sm shadow-lg transition-colors flex items-center justify-center gap-2">
                <span>Save Image</span>
            </button>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="global-file-input" accept="image/*" class="hidden">

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xs border border-slate-700 shadow-2xl flex flex-col gap-3">
            <h3 class="text-lg font-bold text-center mb-2 text-white">Edit Square</h3>
            <button id="btn-change" class="bg-blue-600 text-white py-3 rounded-xl font-semibold active:bg-blue-500">
                Retake / Upload
            </button>
            <button id="btn-delete" class="bg-red-600 text-white py-3 rounded-xl font-semibold active:bg-red-500">
                Clear Photo
            </button>
            <button onclick="closeModal()" class="bg-slate-700 text-slate-300 py-3 rounded-xl font-semibold active:bg-slate-600 mt-2">
                Cancel
            </button>
        </div>
    </div>

    <!-- Hidden Export Container (Fixed position to prevent layout shift) -->
    <div style="position: absolute; left: -9999px; top: 0;">
        <div id="export-container" class="bg-white p-6 w-[800px]">
            <div class="mb-4 text-center border-b-4 border-green-500 pb-4">
                <h1 class="text-5xl font-black text-slate-800 tracking-tighter uppercase">Hermann Park</h1>
                <p class="text-slate-500 text-xl font-bold mt-2 tracking-widest uppercase">Scavenger Hunt â€¢ <span id="export-date"></span></p>
            </div>
            <div id="export-grid" class="grid grid-cols-5 gap-2 bg-slate-100 p-2 border-4 border-slate-800">
                <!-- Export content -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_NAME = 'HermannBingoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'photos';
        
        const prompts = [
            "Turtle", "Bird", "Squirrel", "Handstand", "Someone with Hat",
            "Fountain", "Miller Theatre", "Reflect Pool", "Japanese Garden", "Koi Fish",
            "Sam Houston", "Pedal Boat", "Rice Student", "The Train", "Picnic",
            "Spiral Mound", "Shadow Selfie", "Sign: 'Hermann'", "Flower", "Statue",
            "In a Tunnel", "Dog", "Twisty Tree", "Science Museum", "Pinecone/Leaf"
        ];

        // --- STATE ---
        let db;
        let photoState = new Array(25).fill(null);
        let activeIndex = null;

        // --- DOM ELEMENTS ---
        const boardEl = document.getElementById('game-board');
        const fileInput = document.getElementById('global-file-input');
        const modal = document.getElementById('edit-modal');
        const statusEl = document.getElementById('status-indicator');

        // --- INDEXED DB SETUP (PERSISTENCE) ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };

            request.onsuccess = (e) => {
                db = e.target.result;
                loadGame();
            };

            request.onerror = (e) => {
                console.error("DB Error", e);
                statusEl.innerText = "Error loading save data.";
            };
        }

        function savePhotoToDB(index, base64Data) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put(base64Data, index);
            statusEl.innerText = "Game saved automatically.";
        }

        function deletePhotoFromDB(index) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.delete(index);
            statusEl.innerText = "Photo removed.";
        }

        function loadGame() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            
            // Load all items
            const request = store.openCursor();
            request.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const index = cursor.key;
                    const data = cursor.value;
                    photoState[index] = data;
                    updateSquareVisuals(index, data);
                    cursor.continue();
                } else {
                    statusEl.innerText = "Ready to play!";
                }
            };
        }

        function clearDB() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.clear();
            statusEl.innerText = "Board reset.";
        }

        // --- BOARD LOGIC ---
        function initBoard() {
            boardEl.innerHTML = '';
            prompts.forEach((prompt, index) => {
                const square = document.createElement('div');
                square.id = `square-${index}`;
                
                // Mobile-first classes: smaller text, minimal padding
                let baseClasses = "relative w-full pt-[100%] rounded-md overflow-hidden cursor-pointer shadow-sm transition-transform active:scale-95 ";
                baseClasses += index === 12 ? "bg-emerald-700" : "bg-slate-700";
                
                square.className = baseClasses;
                square.onclick = () => handleSquareClick(index);

                // Using absolute positioning to maintain aspect ratio
                square.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center p-1 z-10 pointer-events-none">
                        <span class="prompt-text text-[9px] sm:text-xs font-bold text-center leading-tight break-words text-white">${prompt}</span>
                    </div>
                    <div class="absolute inset-0 bg-cover bg-center z-0 hidden" id="img-${index}"></div>
                    <div class="absolute inset-0 bg-black/40 z-0 hidden" id="overlay-${index}"></div>
                    <div id="loading-${index}" class="hidden absolute inset-0 flex items-center justify-center bg-slate-800/80 z-20"><div class="loader"></div></div>
                    <div id="check-${index}" class="hidden absolute top-1 right-1 z-20 bg-green-500 rounded-full p-0.5 shadow-sm">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                `;
                boardEl.appendChild(square);
            });
        }

        function handleSquareClick(index) {
            activeIndex = index;
            if (photoState[index]) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                triggerFileUpload();
            }
        }

        function triggerFileUpload() {
            fileInput.value = ''; 
            fileInput.click();
        }

        // --- IMAGE PROCESSING ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || activeIndex === null) return;

            const loadingEl = document.getElementById(`loading-${activeIndex}`);
            loadingEl.classList.remove('hidden');
            statusEl.innerText = "Compressing photo...";

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // Compress
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Aggressive resizing for mobile performance
                    const MAX_SIZE = 600; 
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to JPEG quality 0.6 for small storage size
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    // Save and Update
                    photoState[activeIndex] = dataUrl;
                    savePhotoToDB(activeIndex, dataUrl);
                    updateSquareVisuals(activeIndex, dataUrl);
                    
                    loadingEl.classList.add('hidden');
                };
                img.onerror = () => {
                    alert("Could not load image.");
                    loadingEl.classList.add('hidden');
                }
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function updateSquareVisuals(index, dataUrl) {
            const square = document.getElementById(`square-${index}`);
            const imgDiv = document.getElementById(`img-${index}`);
            const overlay = document.getElementById(`overlay-${index}`);
            const check = document.getElementById(`check-${index}`);
            const text = square.querySelector('.prompt-text');

            imgDiv.style.backgroundImage = `url(${dataUrl})`;
            imgDiv.classList.remove('hidden');
            overlay.classList.remove('hidden');
            check.classList.remove('hidden');
            
            // Fade text but keep slightly visible for reference
            text.classList.add('opacity-0');
            
            square.classList.remove('bg-slate-700', 'bg-emerald-700');
            square.classList.add('border-2', 'border-green-500');
        }

        // --- MODAL & RESET ---
        document.getElementById('btn-change').onclick = () => {
            closeModal();
            setTimeout(triggerFileUpload, 50);
        };

        document.getElementById('btn-delete').onclick = () => {
            const index = activeIndex;
            photoState[index] = null;
            deletePhotoFromDB(index);
            
            // Reset UI
            const square = document.getElementById(`square-${index}`);
            document.getElementById(`img-${index}`).classList.add('hidden');
            document.getElementById(`overlay-${index}`).classList.add('hidden');
            document.getElementById(`check-${index}`).classList.add('hidden');
            square.querySelector('.prompt-text').classList.remove('opacity-0');
            
            square.classList.remove('border-2', 'border-green-500');
            square.classList.add(index === 12 ? 'bg-emerald-700' : 'bg-slate-700');
            
            closeModal();
        };

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function resetBoard() {
            if(confirm("Clear entire board? All photos will be lost.")) {
                photoState.fill(null);
                clearDB();
                initBoard(); // Rebuild grid to clear styles
            }
        }

        // --- EXPORT ---
        async function exportGrid() {
            const btn = document.getElementById('export-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white/50 border-t-white"></div> Saving...`;
            btn.disabled = true;

            try {
                const exportContainer = document.getElementById('export-grid');
                exportContainer.innerHTML = '';
                document.getElementById('export-date').innerText = new Date().toLocaleDateString();

                // Build high-res grid for export
                prompts.forEach((prompt, index) => {
                    const div = document.createElement('div');
                    div.className = "aspect-square bg-slate-200 flex items-center justify-center relative border border-slate-300 overflow-hidden";
                    
                    if (photoState[index]) {
                        div.innerHTML = `
                            <div class="absolute inset-0 bg-cover bg-center" style="background-image: url(${photoState[index]})"></div>
                            <div class="absolute bottom-0 left-0 right-0 bg-black/70 p-1">
                                <p class="text-white text-[10px] font-bold text-center leading-none truncate font-sans">${prompt}</p>
                            </div>
                        `;
                    } else {
                         div.innerHTML = `<p class="text-slate-400 text-[10px] text-center font-bold p-1 leading-tight font-sans uppercase tracking-wide">${prompt}</p>`;
                    }
                    exportContainer.appendChild(div);
                });

                // Render
                await new Promise(r => setTimeout(r, 100)); // Wait for DOM
                const canvas = await html2canvas(document.getElementById('export-container'), {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });

                // Download
                const link = document.createElement('a');
                link.download = `Hermann-Hunt-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();

            } catch (e) {
                console.error(e);
                alert("Export failed. Try reloading.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- START ---
        modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        initBoard();
        initDB();

    </script>
</body>
</html>

